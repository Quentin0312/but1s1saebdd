{% extends 'layout.html' %}

{% block title %}
    <title>afficher l'état de tri</title>
{% endblock %}

{% block body %}
    <script>
        function removeData(chart) {
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update();
        }
        function removeDataRadarChart(chart) {
            chart.data.labels = [];
            chart.data.datasets = [];
            chart.update();
        }

        function addData(chart, labels, datas) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = datas;
            chart.update();
        }

        function addDataRadarChart(chart, labels, datas) {
            chart.data.labels = labels;
            {#chart.data.datasets[0].data = datas;#}
            let datasets = [];

            Object.keys(datas).forEach((key => {
                datasets.push({
                    label: key,
                    fill: true,
                    backgroundColor: "rgba(179,181,198,0.2)",
                    borderColor: "rgba(179,181,198,1)",
                    pointBorderColor: "#fff",
                    pointBackgroundColor: "rgba(179,181,198,1)",
                    data: datas[key]
                });
            }));
            chart.data.datasets = datasets;
            chart.update();
        }

        // TODO : Also filter bar-chart and radar => all the page !!
        async function filterPieChart() {
            const dateDebut = document.getElementById("start-date").value;
            const dateFin = document.getElementById("end-date").value;

            fetch('/tri/etat/piechart?date_debut=' + dateDebut + '&date_fin=' + dateFin)
                .then(response => response.json())
                .then(response => {
                    const result = response;
                    removeData(pieChart);
                    addData(pieChart, result.labels, result.data)
                    {#const result = response;#}
                    {#document.getElementById("pie-chart-container").innerHTML = `#}
                    {#<canvas id="pie-chart" width="100%" height="100%"></canvas>#}
                    {#`;#}
                    {#console.log(result)#}
                    {#setupPieChart(result.labels, result.data)#}
                });
            fetch('/tri/etat/barchart?date_debut=' + dateDebut + '&date_fin=' + dateFin)
                .then(response => response.json())
                .then(response => {
                    const result = response;
                    removeData(barChart);
                    addData(barChart, result.labels, result.data)
                });
            fetch('/tri/etat/radarchart?date_debut=' + dateDebut + '&date_fin=' + dateFin)
                .then(response => response.json())
                .then(response => {
                    const result = response;
                    removeDataRadarChart(radarChart);
                    addDataRadarChart(radarChart, result.labels, result.data);
                });

        }
    </script>
    <div class="show-head-content">
        <h3>État de Tri</h3>
    </div>
    <div style="display: flex;justify-content: center;height: 500px; width: 100%">
        <div style="width: 100%; height: 100%">
            <canvas id="bar-chart" width="100%" height="100%"></canvas>
        </div>
        <div style="width: 100%; height: 100%">
            <div>{{ "Filtre :" }}</div>
            {#    TODO : Set min and max date values depending on ramassages#}
            <label for="start-date">Date de début:</label>
            <input type="date" id="start-date" name="trip-start" value="{{ dateDebut | safe }}"
                   min="{{ dateDebut | safe }}"
                   max="{{ dateFin | safe }}"/>
            <label for="end-date">Date de fin:</label>
            <input type="date" id="end-date" name="trip-start" value="{{ dateFin | safe }}" min="{{ dateDebut | safe }}"
                   max="{{ dateFin | safe }}"/>
            <button onclick="filterPieChart()">Valider</button>
            <div id="pie-chart-container" style="height: 100%">
                <canvas id="pie-chart" width="100%" height="100%"></canvas>
            </div>
            <canvas id="radar-chart" width="800" height="600"></canvas>
        </div>
    </div>
    <script>
        {# TODO : Make it a stacked bar diag => https://www.chartjs.org/docs/latest/samples/bar/stacked.html #}
        // Bar chart
        function setupBarChart(barChartLabels, barChartData) {
            return new Chart(document.getElementById("bar-chart"), {
                type: 'bar',
                data: {
                    labels: barChartLabels,
                    datasets: [
                        {
                            label: "Quantité de vêtements trié (en kg)",
                            backgroundColor: ["#3e95cd"],
                            data: barChartData
                        }
                    ]
                },
                options: {
                    legend: {display: false},
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date de ramassage'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Quantité de vêtements trié (en kg)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Vêtements triées selon le ramassage'
                        }
                    }
                }
            });
        }

        // Pie chart
        function setupPieChart(pieChartLabels, pieChartData) {
            return new Chart(document.getElementById("pie-chart"), {
                type: 'pie',
                data: {
                    labels: pieChartLabels,
                    datasets: [{
                        label: "Total trié (en kg)",
                        {# TODO ; Ajouter une couleur !#}
                        backgroundColor: ["#3e95cd", "#8e5ea2", "#3cba9f", "#e8c3b9", "#c45850"],
                        data: pieChartData
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total trié selon le type de vêtements'
                        }
                    }
                }
            });
        }

        // Radar chart
        function setupRadarChart() {
            console.log({{ radarChartData | safe }});
            const dataDict = {{ radarChartData | safe }};
            let datasets = [];

            Object.keys(dataDict).forEach((key => {
                datasets.push({
                    label: key,
                    fill: true,
                    backgroundColor: "rgba(179,181,198,0.2)",
                    borderColor: "rgba(179,181,198,1)",
                    pointBorderColor: "#fff",
                    pointBackgroundColor: "rgba(179,181,198,1)",
                    data: dataDict[key]
                })
            }))
            // TODO : Fix chart
            return new Chart(document.getElementById("radar-chart"), {
                type: 'radar',
                data: {
                    labels: {{ radarChartLabels | safe }},
                    datasets
                    {#datasets: [#}
                    {#    {#}
                    {#        label: "1950",#}
                    {#        fill: true,#}
                    {#        backgroundColor: "rgba(179,181,198,0.2)",#}
                    {#        borderColor: "rgba(179,181,198,1)",#}
                    {#        pointBorderColor: "#fff",#}
                    {#        pointBackgroundColor: "rgba(179,181,198,1)",#}
                    {#        data: [214, 300, 525, 400, 0, 196]#}
                    {#    }, {#}
                    {#        label: "2050",#}
                    {#        fill: true,#}
                    {#        backgroundColor: "rgba(255,99,132,0.2)",#}
                    {#        borderColor: "rgba(255,99,132,1)",#}
                    {#        pointBorderColor: "#fff",#}
                    {#        pointBackgroundColor: "rgba(255,99,132,1)",#}
                    {#        data: [55, 100, 434, 278, 612, 200]#}
                    {#    }#}
                    {#]#}
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Quantité de vêtements trié par types selon les ramassages'
                        }
                    }
                }
            });
        }

        const pieChart = setupPieChart({{ pieChartLabels | safe }}, {{ pieChartData | safe }});
        const barChart = setupBarChart({{ barChartLabels | safe }}, {{ barChartData | safe }});
        const radarChart = setupRadarChart();
    </script>
{% endblock %}