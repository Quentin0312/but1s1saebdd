{% extends 'layout.html' %}

{% block title %}
    <title>Ajouter une réduction</title>
{% endblock %}

{% block body %}
    <div class="show-head-content">
        <h3>État des Réductions</h3>
    </div>

    <div class="show-head-content form-group mr-3">
        <h2>Selection </h2>
        <div class="form-group mr-3">
            <label for="filter_items">Sélectionner des catégories :</label>
            {% for category in categories %}
                <div class="form-check">
                    <input type="checkbox" name="filter_items" value="{{ category.id }}"
                           class="form-check-input category-checkbox">
                    <label class="form-check-label chckbx">{{ category.libelle }}</label>
                </div>
            {% endfor %}
        </div>

        <button type="button" onclick="filterBarChart()" class="btn btn-primary">Valider</button>
    </div>


    <div style="display: flex; justify-content: space-between">
    </div>
    <div style="display: flex; justify-content: center; height: 500px; width: 100%">
        <canvas id="barChart" width="100%" height="100%"></canvas>
        <canvas id="pieChart" width="100%" height="100%"></canvas>
    </div>

    <script>
        const barCtx = document.getElementById('barChart').getContext('2d');
        const barChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: {{ barChartLabels | tojson }},
                datasets: [{
                    label: 'Total des Réductions (en %)',
                    data: {{ barChartData | tojson }},
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            }
        });

        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: {{ pieChartLabels | tojson }},
                datasets: [{
                    data: {{ pieChartData | tojson }},
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 3
                }]
            }
        });

        function getSelectedValues(className) {
            return Array.from(document.getElementsByClassName(className))
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        async function filterBarChart() {
            const selectedCategories = getSelectedValues('category-checkbox');
            const selectedClientTypes = getSelectedValues('client-checkbox');

            const response = await fetch('/reduction/etat/barchart?categories=' + selectedCategories.join(',') + '&client_types=' + selectedClientTypes.join(','));
            const data = await response.json();

            barChart.data.labels = data.labels;
            barChart.data.datasets[0].data = data.data;
            barChart.update();
        }
    </script>
{% endblock %}
