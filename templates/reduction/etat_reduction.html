{% extends 'layout.html' %}

{% block title %}
    <title>Ajouter une réduction</title>
{% endblock %}

{% block body %}
    <div class="show-head-content">
        <h3>État des Réductions</h3>
    </div>

    <div class="show-head-content form-group mr-3">
        <h2>Selection </h2>
        <div class="form-group mr-3">
            <label for="filter_items">Sélectionner des catégories :</label>
            {% for category in categories %}
                <div class="form-check">
                    <input type="checkbox" name="filter_items" value="{{ category.id }}"
                           class="form-check-input category-checkbox">
                    <label class="form-check-label chckbx">{{ category.libelle }}</label>
                </div>
            {% endfor %}
        </div>

        <button type="button" onclick="filterBarChart()" class="btn btn-primary">Valider</button>
    </div>


    <div style="display: flex; justify-content: space-around">
    </div>
    <div style="display: flex; justify-content: center; height: 500px; width: 100%">
        <canvas id="barChart" width="100%" height="100%"></canvas>
        <canvas id="pieChart" width="100%" height="100%"></canvas>
    </div>

    <script>
        function setupBarChart(labels, data) {
            return new Chart(document.getElementById("barChart"), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Total des Réductions (en %)",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1,
                        data: data
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Réductions par type de vêtement',
                            font: {
                                size: 20
                            }
                        }
                    }
                }
            });
        }

        function setupPieChart(labels, data) {
            return new Chart(document.getElementById("pieChart"), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        backgroundColor: ["#3e95cd", "#8e5ea2", "#3cba9f", "#e8c3b9", "#c45850"],
                        borderColor: "#fff",
                        borderWidth: 3,
                        data: data
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Répartition des réductions par catégorie de clients',
                            font: {
                                size: 20
                            }
                        }
                    }
                }
            });
        }

        // Initialiser les graphiques avec les données Flask
        const barChart = setupBarChart({{ barChartLabels | tojson }}, {{ barChartData | tojson }});
        const pieChart = setupPieChart({{ pieChartLabels | tojson }}, {{ pieChartData | tojson }});

        function getSelectedValues(className) {
            return Array.from(document.getElementsByClassName(className))
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }

        async function filterBarChart() {
            const selectedCategories = getSelectedValues('category-checkbox');
            const selectedClientTypes = getSelectedValues('client-checkbox');

            const response = await fetch('/reduction/etat/barchart?categories=' + selectedCategories.join(',') + '&client_types=' + selectedClientTypes.join(','));
            const data = await response.json();

            barChart.data.labels = data.labels;
            barChart.data.datasets[0].data = data.data;
            barChart.update();
        }

    </script>

{% endblock %}
